@using UPProjects.Models
@model UPProjects.Models.ProgressPhotoUpload


@{
    ViewData["Title"] = "ProgressPhotoUpload";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section CSS{
<style>
img#imgFile {
    width: 100%;
    height: 300px;
    object-fit: cover;
    }
    </style >
    }
    <div class="row page-title-header" >
    <div class="col-12" >
    <div class="page-header" >
    <h4 class="page-title" > Upload Progress Photo of Projects</h4 >
    </div >
    </div >
    </div >

    <div class="col-md-12 grid-margin stretch-card" >
    <div class="card" >
    <div class="card-body" >
        <form class="forms-sample" method="post" asp-action="ProgressPhotoUpload"
              enctype="multipart/form-data" data-ajax="true" data-ajax-method="POST"
              data-ajax-begin="onBegin" data-ajax-complete="onComplete"
              data-ajax-failure="onFailed" data-ajax-success="onSuccess">
            <div asp-validation-summary="ModelOnly" class="text-danger"> </div>

            <div class="form-group">
                <div class="row">
                    <div class="col-sm-4">
                        <label asp-for="UnitId"> </label>
                        <select asp-for="UnitId" class="form-control" asp-items="@Model.Units" id="UnitId" onchange="BindProjects();">
                        </select>
                        <span asp-validation-for="UnitId" class="text-danger"> </span>
                    </div>
                    <div class="col-sm-4">
                        <label asp-for="Category"> </label>
                        <select asp-for="Category" class="form-control" id="Category" onchange="BindYearMonth();">
                            <option value="0"> Select Category</option>
                            <option value="2"> On Going Project</option>
                            <option value="3"> Completed Project</option>
                        </select>
                        <span asp-validation-for="Category" class="text-danger"> </span>
                    </div>
                    <div class="col-sm-4">
                        <label asp-for="ProjectId"> </label>
                        <select asp-for="ProjectId" asp-items="@Model.Projects" class="form-control" id="ProjectId">
                        </select>
                        <span asp-validation-for="ProjectId" class="text-danger"> </span>
                    </div>
                </div>
            </div>
            <div class="form-group" id="divYear" style="display:none;">
                <div class="row">
                    <div class="col-sm-6">
                        <label asp-for="Year">Year * </label>
                        <select asp-for="Year" asp-items="@Model.Years" class="form-control" id="Year" onchange="BindMonth();">
                        </select>
                        <span asp-validation-for="Year" class="text-danger"> </span>
                    </div>
                    <div class="col-sm-6">
                        <label asp-for="Month">Month * </label>
                        <select asp-for="Month" asp-items="@Model.Months" class="form-control" id="Month">
                        </select>
                        <span asp-validation-for="Month" class="text-danger"> </span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-sm-6" style="display:none">
                        <label asp-for="Title"> </label>
                        <input type="text" asp-for="Title" autocomplete="off" class="form-control" id="Title" placeholder="Title">
                        <span asp-validation-for="Title" class="text-danger"> </span>
                    </div>
                    <div class="col-sm-6">
                        <label asp-for="Description"> </label>
                        <textarea class="form-control" asp-for="Description" id="Description" rows="2"> </textarea>
                        <span asp-validation-for="Description" class="text-danger"> </span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-sm-6">
                        <label asp-for="file">Upload Photo<span style="color:red"> &nbsp;(Photo must be in png,jpg or jpeg format and size should be less than or equal to 1MB.) </span> </label>
                        <input type="file" id="file" asp-for="file" class="form-control" multiple="multiple">
                        <span asp-validation-for="file" class="text-danger"> </span>
                        @if (Model.Id=="0"|| Model.Id==null)
                        {
                            <span class="text-danger" style="font-size:15px;">(Select Multiple Photo by pressing Ctrl key+Left click of Mouse.)</span>
                        }

                    </div>
                    <div class="col-sm-6">
                        @if (Model != null)
                        {
                            if (!string.IsNullOrEmpty(Model.FileName))
                            {
                                <img id="imgFile" src="@Model.FileName" height="300px" width="800px" />
                            }
                        }
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-success mr-2" id="btnsub">@ViewBag.ButtonText </button>
            <a class="btn btn-dark" href="/ProgressPhotoUpload/ProgressPhotoUpload"> Reset</a>
            <a class="btn btn-light" href="/ProgressPhotoUpload/ProgressPhotoUploadList"> Go To List</a>
        </form>
    </div >
    </div >
    </div >
    @section Scripts{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script type="text/javascript" >
    $(document).ready(function () {
            $(".calender").datepicker(
                {
                    dateFormat: 'dd/mm/yy',
                    maxDate: new Date()
                });
           var divYear = "@ViewBag.divYear";
            if (divYear == 1) {
               BindYearMonth();
            }
        });
    </script >
    <script type="text/javascript" >

    function readURL(input) {
        if (input.files && input.files[0]) {
    var reader = new FileReader();

    reader.onload = function(e) {
      $('#imgFile').attr('src', e.target.result);
    }

    reader.readAsDataURL(input.files[0]); // convert to base64 string
  }
}

$("#file").change(function() {
  readURL(this);
});

        function BindProjects() {
            $('#loader').css("display","block");
            var unit = $('#UnitId').val();
            $.get('@Url.Action("GetProjects","ProgressPhotoUpload")', {
                unit:unit
    }, function (data) {
                    try {
                        
                        $('#ProjectId').empty();                      
                        $.each(data, function (key, value) {
                        
                            $('#ProjectId').append('<option value="'+value.id+'">'+value.value+'</option>');
                        });$('#loader').css("display","none");
        }
                    catch (err) {
                        $('#loader').css("display","none");
        }
            }).done(function (data) {
        $('#loader').css("display","none");
        })
                .fail(function (data) {
            $('#loader').css("display","none");
        });
        }

        function BindYearMonth() {
            $('#loader').css("display","block");
            var Category = $('#Category').val();
            if (Category === "2") {
                $('#divYear').css("display", "block");
            }
            else {
                $('#divYear').css("display", "none");
                $('#Year').val('0');
                $('#Month').empty();
            }
            $('#loader').css("display","none");
        }
        function BindMonth() {
            $('#loader').css("display","block");
            var year = $('#Year').val();
            $.get('@Url.Action("BindMonth","ProgressPhotoUpload")', {
                year:year
    }, function (data) {
                    try {
                        $('#Month').empty();
                         $('#Month').append('<option value="0">Select Month</option>');
                        $.each(data, function (key, value) {
                            debugger;
                            $('#Month').append('<option value="'+value.Id+'">'+value.Value+'</option>');
                        });
                        $('#loader').css("display","none");
        }
                    catch (err) {
                        $('#loader').css("display","none");
        }
            }).done(function (data) {
        $('#loader').css("display","none");
        })
                .fail(function (data) {
            $('#loader').css("display","none");
        });
        }

        var onBegin = function () {
           
            if ($('#file').val() !== '') {
                var file = $('#file').get(0);
                var FileSize = file.files[0].size;;
                var path = $('#file').val();
                var FileSizeKB = (FileSize / 1024).toFixed(2);
                var ext = path.substring(path.lastIndexOf(".") + 1, path.length).toLowerCase();
                if (ext == "png" || ext == "jpg" || ext == "jpeg") {
                    if (FileSizeKB > 1024) {
                        alert("Photo Size must be less than or equal to 1024 KB (1 MB).");
                        $(this).val("");
                        $(this).focus();
                        return false;
                    }
                }
                else {
                    alert("Upload photo must be in png, jpg or jpeg format.");
                    $('#file').focus();
                    $('#file').val('');
                    return false;
                }
            }
            else {
                var flag = "@ViewBag.ButtonText";
                if (flag=== "Submit") {
                    alert("Please upload Photo.");
                    $('#file').focus();
                    $('#file').val('');
                    return false;
                }
            }

         var Category = $('#Category').val();
            if (Category === "2") {
                if ($('#Year').val() === "0" || $('#Year').val() === "") {
                    alert('Please select year.');
                    return false;
                }
                if ($('#Month').val() === "0" || $('#Month').val() === "") {
                    alert('Please select Month.');
                    return false;
                }
            }
            $('#loader').css("display","block");
            return true;
            //var isValDate = /^(((0[1-9]|[12]\d|3[01])\/(0[13578]|1[02])\/((19|[2-9]\d)\d{2}))|((0[1-9]|[12]\d|30)\/(0[13456789]|1[012])\/((19|[2-9]\d)\d{2}))|((0[1-9]|1\d|2[0-8])\/02\/((19|[2-9]\d)\d{2}))|(29\/02\/((1[6-9]|[2-9]\d)(0[48]|[2468][048]|[13579][26])|((16|[2468][048]|[3579][26])00))))$/;
            //var DateOfActivity = $('#DateOfActivity').val();
            //if (DateOfActivity != "") {
            //    if (!isValDate.test(DateOfActivity)) {
            //        alert("Please Enter Valid Date Format (dd/mm/yyyy).");
            //        $('#DateOfActivity').focus();
            //        return false;
            //    }
            //}
        };
        var onComplete = function (result) {
            $('#loader').css("display", "none");
        };
        var onSuccess = function (Response) {
            debugger;
            alert(Response.dynamicResult.innerresult.Message);
            if (parseInt(Response.dynamicResult.innerresult.Status) > 0) {
                //$('#Title').val('');
                //$('#Description').val('');
                //$('#DateOfActivity').val('');
                //$('#file').val('');
                //$('#Year').val('0');
                //$('#Month').empty();
                //$('#Category').val("0");
                if (Response.dynamicResult.innerresult.Action === 'I') {
                    $('#Title').val('');
                $('#Description').val('');
             
                $('#file').val('');
                }
                    // location.href = '/progressphotoupload/progressphotoupload';
            }
        };
        var onFailed = function () {
              $('#loader').css("display", "none");
        };

    </script>

}